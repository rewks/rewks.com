---
title: 'Automating a simple Velociraptor deployment in AWS (Part 2)'
date: '2023-04-11'
tags: ['VELOCIRAPTOR', 'INCIDENT RESPONSE', 'AUTOMATION', 'TERRAFORM', 'AWS']
description: 'Following on from part 1, I look at the actual code required'
image: '/blog-images/automated-velociraptor-deployment/cover-img.png'
draft: true
---

Ok, so this post is waaay overdue. It was meant to be a quick followup to [part one which was posted months ago](/blog/automated-velociraptor-deployment). Sometimes life just gets in the way, but it is here now!

## Installs

I briefly covered pre-reqs in the last post but let's just list what you should have installed here so it is all smooth sailing:

1. Terraform [Install Guide](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli)
2. AWS CLI [Install Guide](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
3. Ansible [Install Guide](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#pip-install)

## AWS Setup

### IAM Account

Terraform will need to use an account to manage resources so in your AWS console go to IAM dashboard and select <Keyword text="User groups"/> from the left-hand menu. Create a new group and name it however you like, I went with "dfir-users". Scroll down to the <Keyword text="permissions policies"/> section and grant the following:

- AmazonEC2FullAccess
- AmazonElasticFileSystemFullAccess
- AmazonRoute53DomainsFullAccess

With the group and permissions set, from the left-hand menu go into <Keyword text="User"/> and then click the add users button. Again choose whatever name you wish, I went with "dfir-terraform". Click next and then select the group you just created. Continue through to the review screen and click create user.

Now go back into the user you just created and go to the <Keyword text="Security Credentials"/> tab. Scroll down to <Keyword text="Access keys"/> and click the create access key button. Choose "Command Line Interface" and continue.

<div className="img_three_quarters_screen">
    <Image 
        src='/blog-images/automated-velociraptor-deployment-2/iam-user-screen.png'
        alt='Screenshot of IAM user screen highlighting Security Credentials tab'
        width={1239}
        height={660}
        style={{width: "100%", height: "auto"}}
    />
</div>

Now in your terminal, configure the AWS CLI to use the access keys you just generated for authentication.

```plain
aws configure
```

Go through the prompts entering the relevant information and you're done!

### Static Components

As noted in the part 1 blog post, there are some components of the deployment that are costless and make sense to be left standing. So let's see how to manually create them in the AWS console. 

**In all of these, make sure you're setting them up in the right region!**

#### Virtual Private Cloud (and others)

Go to the VPC dashboard and click on Create VPC. In the menu select the <Keyword text="VPC and more"/> option and go through the inputs, choose whatever tag and CIDR blocks you wish, just make sure you select 1 public subnet otherwise an Internet Gateway won't be set up.

<div className="img_three_quarters_screen">
    <span>
        <Image 
            src='/blog-images/automated-velociraptor-deployment-2/vpc-settings-1.png'
            alt='VPC and related components creation screen part 1'
            width={490}
            height={740}
            style={{width: "50%", height: "auto"}}
        />
    </span>
    <span>
        <Image 
            src='/blog-images/automated-velociraptor-deployment-2/vpc-settings-2.png'
            alt='VPC and related components creation screen part 2'
            width={490}
            height={740}
            style={{width: "50%", height: "auto"}}
        />
    </span>
</div>

This takes care of the VPC, the Subnet, the Internet Gateway, the Route Table and the Network Security Group.

#### Route53 Hosted Zone

In the Route 53 dashboard, go to <Keyword text="Hosted zones"/> on the left-hand menu. Click on <Keyword text="Create hosted zone"/> and go through the set up steps - you will need your own domain for this and the ability to configure it's configured name servers. If you don't have a domain you can still follow along but you'll need to make minor changes at some points to use the public IP of the EC2 instance rather than a domain.

## Terraform

I originally combined both the Terraform and Ansible scripts, by having Terraform's remote-exec provisioner run the Ansible script on the server after all the infrastructure had finished being stood up but I've now leaned more toward keeping them separate. The user will first run the Terraform script to create all the infrastructure, and then run the Ansible script to configure the server. It is an extra action required on behalf of the user which may be heresy in the automation world but it feels more comfortable to me to have each stage separated... and it's my script so there. You can easily change this back to how I originally had it with a bit of documentation reading anyway.